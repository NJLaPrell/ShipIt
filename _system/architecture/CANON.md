# Architecture Canon

> **This document is the authoritative source for system architecture.**
> Code that violates this canon is illegal. Update this document before implementing violations.

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ShipIt System                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Intent Layer        â”‚  Execution Layer    â”‚  Verification  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  work/intent/        â”‚  work/workflow-state/ â”‚  CI/CD       â”‚
â”‚  work/roadmap/       â”‚  .cursor/rules/     â”‚  Tests         â”‚
â”‚  _system/do-not-repeat/ â”‚ .cursor/commands/ â”‚  Linting      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Boundaries

### Layer Responsibilities

| Layer              | Responsibility               | Cannot Do                  |
| ------------------ | ---------------------------- | -------------------------- |
| **Intent**         | Define WHAT to build         | Specify HOW to implement   |
| **Architecture**   | Define HOW systems connect   | Write production code      |
| **Implementation** | Write code that passes tests | Change architecture        |
| **Verification**   | Prove correctness            | Weaken acceptance criteria |

### Directory Boundaries

**Full map:** See [docs/DIRECTORY_STRUCTURE.md](../../docs/DIRECTORY_STRUCTURE.md) for a quick reference.

| Directory                | Purpose                                                                                                                                        | Owner              | Modification Rules                                                |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------- | ------------------ | ----------------------------------------------------------------- |
| `work/intent/`           | Planned work (features, bugs, tech-debt)                                                                                                       | PM, Steward        | Anyone can propose; Steward approves                              |
| `_system/architecture/`  | System boundaries, invariants, schemas, ADRs                                                                                                   | Architect, Steward | Requires ADR for changes                                          |
| `work/workflow-state/`   | Current execution state (phases, status, assumptions). Layout: flat or per-intent; see [workflow-state-layout.md](./workflow-state-layout.md). | All agents         | Append-only during execution; consumers must support both layouts |
| `_system/do-not-repeat/` | Failed approaches (abandoned designs, bad patterns, rejected libs)                                                                             | All agents         | Append-only; never delete                                         |
| `/src/`                  | Production source code                                                                                                                         | Implementer        | Must follow approved plan                                         |
| `/tests/`                | Test code, fixtures, run logs, process docs (see tests/README.md)                                                                              | QA, Implementer    | Tests before implementation                                       |
| `_system/artifacts/`     | Generated files (SYSTEM_STATE.md, dependencies.md, confidence-calibration.json)                                                                | Scripts            | Regenerated by generate-\* and verify scripts                     |
| `work/release/`          | Generated release plan (ordered intents by release target)                                                                                     | Scripts            | Regenerated by generate-release-plan.sh                           |
| `work/roadmap/`          | Planning views (now, next, later triage)                                                                                                       | Scripts            | Regenerated by generate-roadmap.sh                                |
| `/scripts/`              | Shell scripts for workflow, generation, validation, deploy                                                                                     | All                | Add with approval; follow lib/ for shared code                    |
| `_system/security/`      | Audit allowlist, security config                                                                                                               | Security, Steward  | Append-only for allowlist                                         |
| `_system/behaviors/`     | Procedures and policies (release, issue tracking, platform work)                                                                               | All                | Document how we work                                              |
| `_system/reports/`       | Generated reports (mutation, coverage, etc.)                                                                                                   | Scripts            | Regenerated; often gitignored                                     |
| `_system/golden-data/`   | Replay validation test data for regression testing                                                                                             | QA                 | Append-only; capture known-good inputs/outputs                    |
| `/projects/`             | Initialized ShipIt projects (from /init-project)                                                                                               | Scripts            | Contents gitignored; .gitkeep only committed                      |
| `_system/drift/`         | Entropy baselines and metrics                                                                                                                  | Scripts            | Regenerated by drift-check.sh                                     |
| `/.cursor/`              | Cursor config (commands/, rules/, agents/)                                                                                                     | All                | Commands and rules are first-class; version controlled            |

## Allowed Dependencies

### External Dependencies

| Category     | Allowed            | Forbidden                  |
| ------------ | ------------------ | -------------------------- |
| **Runtime**  | Node.js LTS        | Experimental Node features |
| **Language** | TypeScript 5.x     | JavaScript (must be TS)    |
| **Testing**  | Vitest, fast-check | Jest (use Vitest instead)  |
| **Linting**  | ESLint, Prettier   | TSLint (deprecated)        |
| **Build**    | esbuild, tsup      | Webpack (too complex)      |

### Internal Dependencies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    /src/     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   domain/    â”‚ â† Pure business logic, no I/O
â”‚   services/  â”‚ â† Orchestration, uses domain
â”‚   adapters/  â”‚ â† External integrations
â”‚   utils/     â”‚ â† Shared utilities
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Allowed: domain â† services â† adapters
         utils can be used by any layer
Forbidden: domain â†’ services (no upward deps)
           circular dependencies
```

## Forbidden Patterns

### Code Patterns

| Pattern               | Reason              | Alternative                 |
| --------------------- | ------------------- | --------------------------- |
| `any` type            | Defeats type safety | Use `unknown` + type guards |
| `eval()`              | Security risk       | Use safe alternatives       |
| `innerHTML`           | XSS vulnerability   | Use textContent or DOM APIs |
| `console.log` in prod | Leaks info          | Use structured logger       |
| Circular imports      | Architectural smell | Refactor dependencies       |

### Architectural Patterns

| Pattern              | Reason          | Alternative           |
| -------------------- | --------------- | --------------------- |
| God objects          | Unmaintainable  | Single responsibility |
| Deep inheritance     | Fragile         | Composition           |
| Global mutable state | Race conditions | Dependency injection  |
| Magic strings        | Typo-prone      | Constants/enums       |

## Performance Budgets

| Metric      | Budget  | Measurement       |
| ----------- | ------- | ----------------- |
| p95 latency | < 200ms | API response time |
| p99 latency | < 500ms | API response time |
| Memory      | < 512MB | Process RSS       |
| Bundle size | < 1MB   | Production build  |
| Test suite  | < 60s   | Full test run     |

## Security Requirements

### Authentication & Authorization

- All endpoints require authentication except: `/health`, `/metrics`
- Use principle of least privilege
- Session tokens expire after 24h max
- Refresh tokens require re-authentication after 7 days

### Data Handling

- PII must be encrypted at rest
- Secrets never logged
- All user input validated and sanitized
- SQL queries must use parameterized statements

### High-Risk Domains (Require Human Approval)

- ğŸ” Authentication changes
- ğŸ’° Payment processing
- ğŸ”‘ Permission/RBAC changes
- ğŸ—ï¸ Infrastructure changes
- ğŸ“‹ PII handling changes

## Schema Compatibility

- Database migrations must be backward compatible for 3 versions
- API changes must maintain backward compatibility
- Breaking changes require deprecation period (minimum 1 version)

## ADR Log

Architecture Decision Records are stored in `_system/architecture/ADR-###.md`.

| ADR     | Decision                       | Date       |
| ------- | ------------------------------ | ---------- |
| ADR-001 | Use TypeScript + Node.js       | 2026-01-12 |
| ADR-002 | Use Vitest over Jest           | 2026-01-12 |
| ADR-003 | Prefer config over custom code | 2026-01-12 |

---

_Last updated: 2026-02-04_
_Approved by: Steward_
