# Test Runner Agent

You are executing the ShipIt test plan. Follow these rules strictly.

## Mode Detection

Before doing ANYTHING, check your environment:

```bash
cat project.json 2>/dev/null | grep '"name"'
```

- If output contains `"shipit-test"` ‚Üí **TEST PROJECT MODE** (start at step 2-2)
- If `project.json` exists but name is **not** `shipit-test` ‚Üí **STOP** (blocking failure)
- Otherwise ‚Üí **ROOT PROJECT MODE** (run steps 1-1 through 1-4 only)

## Execution Rules

### 1. Use Hardcoded Inputs

**Never ask the user for test inputs.** Use values from `tests/fixtures.json`:

| Step | Field | Value |
|------|-------|-------|
| 1-2 | techStack | `1` |
| 1-2 | description | `Test project for ShipIt end-to-end validation` |
| 1-2 | highRiskDomains | `none` |
| 3-1 | scopeDescription | `Build a todo list app with CRUD, tagging, and persistence` |
| 4-1 | newIntent.typeChoice | `1` |
| 4-1 | newIntent.title | `Add due dates to todos` |
| 4-1 | newIntent.motivationLines | `Improve prioritization for users`, `Support basic deadline tracking` |
| 4-1 | newIntent.priorityChoice | `2` |
| 4-1 | newIntent.effortChoice | `2` |
| 4-1 | newIntent.releaseTargetChoice | `2` |
| 4-1 | newIntent.dependenciesInput | `none` |
| 4-1 | newIntent.riskChoice | `2` |
| 7-2 | priority | `p0` |
| 7-2 | effort | `s` |
| 7-2 | releaseTarget | `R1` |

**Note:** `./scripts/new-intent.sh` prompts in this order:
type ‚Üí title ‚Üí motivation lines (until `done`) ‚Üí priority ‚Üí effort ‚Üí release target ‚Üí dependencies ‚Üí risk.

### 2. Fail-Fast on Blocking Failures

**STOP immediately** if any of these occur:
- Project creation fails
- Required files missing after initialization
- Script execution fails with non-zero exit code
- Generated output files are empty or missing
- `tests/fixtures.json` is missing

Mark the failure as `blocking` severity and halt testing.

When stopping early, mark all remaining steps as `‚è≠Ô∏è SKIP` with reason: `Blocked by step X-Y`.

### 3. Record Every Step

After each step, record:
- Step ID (e.g., `3-2`)
- Step name (from TEST_PLAN.md)
- Status: `PASS` or `FAIL`
- If FAIL: severity, expected vs actual, error details

### 4. Issue Tracking (GitHub ONLY)

Issues discovered during test execution are tracked **only** on GitHub, following `behaviors/WORK_TEST_PLAN_ISSUES.md`.

- Do **not** write new ‚ÄúISSUE-XXX‚Äù entries into `tests/ISSUES.md`.
- `tests/ISSUES.md` is **test run logging only**.

#### Create an Issue (required on failures)

Use `gh` to create issues (per repo rules). Do **not** include literal `\n` sequences in the body (they look gross in the GitHub UI). Use a heredoc body instead.

Preferred: use the helper script so the issue body always matches the template shape:

```bash
./scripts/create-test-plan-issue.sh \
  --title "new-intent prompts out of sync with TEST_PLAN.md" \
  --severity high \
  --step "4-1" \
  --expected "Running /new_intent with fixture-aligned inputs succeeds non-interactively." \
  --actual "new-intent prompts changed (priority/effort/release/deps added) and the fixture input stream runs out; script exits non-zero." \
  --error "<paste error output>" \
  --impl "Update tests/TEST_PLAN.md + tests/fixtures.json to match the prompt sequence" \
  --impl "Update /test-shipit docs to include the full non-interactive input stream"
```

Example:

```bash
gh issue create --title "scope-project fails on macOS bash 3.2" --body "$(cat <<'EOF'
**Severity:** high
**Step:** 3-1
**First Seen:** 2026-01-28

## Expected

`./scripts/scope-project.sh` runs on macOS default shell.

## Actual

Script exits early with a bash syntax error / unsupported feature.

## Error

<paste error output>

## Implementation

- Make script compatible with bash 3.2 or document bash 4+ prerequisite.
EOF
)"
```

### 5. Summary Table Format

```markdown
## Summary

| Step | Name | Status | Severity | Notes |
|------|------|--------|----------|-------|
| 1-1 | Init project | ‚úÖ PASS | - | |
| 1-2 | Provide inputs | ‚úÖ PASS | - | |
| 6-2 | Roadmap reflects deps | ‚ùå FAIL | blocking | F-002 in wrong bucket |
```

Use these status indicators:
- `‚úÖ PASS` ‚Äî Step completed successfully
- `‚ùå FAIL` ‚Äî Step failed
- `‚è≠Ô∏è SKIP` ‚Äî Skipped due to blocking failure or root-mode stop
- `üîÑ RETEST` ‚Äî Needs manual retest

### 6. Severity Definitions

| Severity | Meaning | Action |
|----------|---------|--------|
| `blocking` | Prevents subsequent tests | STOP testing |
| `high` | Core functionality broken | Continue, but flag |
| `medium` | Works but incorrectly | Continue |
| `low` | Minor/cosmetic | Continue |

### 7. Final Output

After completing (or stopping), output:

```markdown
## Test Run Complete

**Date:** [ISO timestamp]
**Mode:** [root-project | test-project]
**Steps Executed:** X
**Steps Passed:** Y
**Steps Failed:** Z
**Blocking Issues:** N

**Result:** [PASS if no failures | FAIL if any failures]

See tests/ISSUES.md for details.
```

## Run Logging Rules

- Do NOT overwrite previous runs.
- Append a new run block to `tests/ISSUES.md` with timestamp, mode, and summary.
- If issues were created, include an ‚ÄúIssues Found This Run‚Äù list referencing GitHub issue numbers (e.g., `#123`).

## Forbidden Actions

- ‚ùå Do NOT ask user for inputs that are in fixtures.json
- ‚ùå Do NOT continue testing after a blocking failure
- ‚ùå Do NOT modify production code during testing
- ‚ùå Do NOT skip steps without marking them as skipped
- ‚ùå Do NOT track issues in `tests/ISSUES.md` (GitHub only)
